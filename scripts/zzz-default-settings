#!/bin/bash

. /etc/os-release
. /lib/functions/uci-defaults.sh

# 判断架构
ARCH=$(uname -m)

# 删除已有 openwrt_core 源
sed -i '/openwrt_core/d' /etc/opkg/distfeeds.conf

# 根据架构添加对应源
if [ "$ARCH" = "x86_64" ]; then
    sed -i "\$a\src/gz openwrt_core https://core.kejizero.online/x86_64/$(grep Version /usr/lib/opkg/info/kernel.control | awk '{print $2}')" /etc/opkg/distfeeds.conf
else
    sed -i "\$a\src/gz openwrt_core https://core.kejizero.online/aarch64_generic/$(grep Version /usr/lib/opkg/info/kernel.control | awk '{print $2}')" /etc/opkg/distfeeds.conf
fi

# OTA
OTA_URL="https://github.com/grandway2025/Actions-OpenWrt/date/ota.json"
uci set ota.config.api_url="$OTA_URL"
uci commit ota

# irqbalance
uci set irqbalance.irqbalance.enabled='0'
uci commit irqbalance
service irqbalance stop

# Set default theme to luci-theme-argon
uci set luci.main.mediaurlbase='/luci-static/argon'
uci commit luci

# Set argon config
uci set argon.@global[0].mode='dark'
uci commit argon

# firewall
[ $(grep -c shortcut_fe /etc/config/firewall) -eq '0' ] && uci set firewall.@defaults[0].flow_offloading='1'
uci set firewall.@defaults[0].input='ACCEPT'
uci commit firewall

# Set NTP
uci -q batch <<-EOF
	set system.@system[0].timezone='CST-8'
	set system.@system[0].zonename='Asia/Shanghai'

	delete system.ntp.server
	add_list system.ntp.server='ntp1.aliyun.com'
	add_list system.ntp.server='ntp.tencent.com'
	add_list system.ntp.server='ntp.ntsc.ac.cn'
	add_list system.ntp.server='time.apple.com'
EOF
uci commit system

# diagnostics
uci set luci.diag.ping='www.qq.com'
uci set luci.diag.route='www.qq.com'
uci set luci.diag.dns='www.qq.com'
uci commit luci

# ttyd
uci set ttyd.@ttyd[0].command='/bin/login -f root'
uci commit ttyd
/etc/init.d/ttyd restart

# Set lucky
uci set lucky.@lucky[0].enabled='0'
uci commit lucky
/etc/init.d/lucky restart

# Set up hostname mapping
uci add dhcp domain
uci set "dhcp.@domain[-1].name=time.android.com"
uci set "dhcp.@domain[-1].ip=203.107.6.88"
uci commit dhcp

# Set SSH
uci delete ttyd.@ttyd[0].interface
uci set dropbear.@dropbear[0].Interface=''
uci commit

# Set zram
mem_total=$(grep MemTotal /proc/meminfo | awk '{print $2}')
zram_size=$(echo | awk "{print int($mem_total*0.25/1024)}")
uci set system.@system[0].zram_size_mb="$zram_size"
uci set system.@system[0].zram_comp_algo='lz4'
uci commit system

# nginx
uci set nginx.global.uci_enable='true'
uci del nginx._lan
uci del nginx._redirect2ssl
uci add nginx server
uci rename nginx.@server[0]='_lan'
uci set nginx._lan.server_name='_lan'
uci add_list nginx._lan.listen='80 default_server'
uci add_list nginx._lan.listen='[::]:80 default_server'
#uci add_list nginx._lan.include='restrict_locally'
uci add_list nginx._lan.include='conf.d/*.locations'
uci set nginx._lan.access_log='off; # logd openwrt'
uci commit nginx
service nginx restart

# docker mirror
if [ -f /etc/config/dockerd ] && [ $(grep -c daocloud.io /etc/config/dockerd) -eq '0' ]; then
    uci add_list dockerd.globals.registry_mirrors="https://docker.m.daocloud.io"
    uci commit dockerd
fi

# extra packages
grep -q IceG_repo /etc/opkg/customfeeds.conf || echo 'src/gz zhiern_repo https://opkg.kejizero.online/openwrt-24.10/x86_64' >> /etc/opkg/customfeeds.conf
opkg-key add /root/my-private.key.pub

# x86_64 kernel packages
# sed -i '/openwrt_core/d' /etc/opkg/distfeeds.conf
# sed -i "\$a\src/gz openwrt_core https://core.kejizero.online/x86_64/$(grep Version /usr/lib/opkg/info/kernel.control | awk '{print $2}')" /etc/opkg/distfeeds.conf

### nikki
# 设置基础状态
uci set nikki.status='status'

# 主配置
uci set nikki.config=config
uci set nikki.config.init='1'
uci set nikki.config.enabled='0'  # 关闭
uci set nikki.config.profile='subscription:subscription'
uci set nikki.config.start_delay='5'
uci set nikki.config.scheduled_restart='0'
uci set nikki.config.cron_expression='0 3 * * *'
uci set nikki.config.test_profile='0'
uci set nikki.config.fast_reload='1'

# 代理设置
uci set nikki.proxy=proxy
uci set nikki.proxy.enabled='1'
uci set nikki.proxy.tcp_mode='redirect'
uci set nikki.proxy.udp_mode='tproxy'
uci set nikki.proxy.ipv4_dns_hijack='1'
uci set nikki.proxy.ipv6_dns_hijack='1'
uci set nikki.proxy.ipv4_proxy='1'
uci set nikki.proxy.ipv6_proxy='1'
uci set nikki.proxy.fake_ip_ping_hijack='0'
uci set nikki.proxy.router_proxy='1'
uci set nikki.proxy.lan_proxy='1'
uci add_list nikki.proxy.lan_inbound_interface='lan'
uci add_list nikki.proxy.bypass_dscp='4'
uci set nikki.proxy.bypass_china_mainland_ip='1'
uci set nikki.proxy.proxy_tcp_dport='21 22 80 110 143 194 443 465 853 993 995 8080 8443'
uci set nikki.proxy.proxy_udp_dport='123 443 8443'

# 订阅配置（需替换真实URL）
# uci set nikki.subscription=subscription
# uci set nikki.subscription.name='订阅配置'
# uci set nikki.subscription.url='http://your_real_subscription_url.yaml'  # 请修改
# uci set nikki.subscription.user_agent='clash.meta'
# uci set nikki.subscription.prefer='remote'

# 混合配置
uci set nikki.mixin=mixin
uci set nikki.mixin.log_level='warning'
uci set nikki.mixin.mode='rule'
uci set nikki.mixin.match_process='off'
uci set nikki.mixin.ipv6='1'
uci set nikki.mixin.ui_path='ui'
uci set nikki.mixin.ui_url='https://github.com/Zephyruso/zashboard/releases/latest/download/dist.zip'
uci set nikki.mixin.api_listen='[::]:9090'
uci set nikki.mixin.selection_cache='1'
uci set nikki.mixin.allow_lan='1'
uci set nikki.mixin.http_port='8080'
uci set nikki.mixin.socks_port='1080'
uci set nikki.mixin.mixed_port='7890'
uci set nikki.mixin.redir_port='7891'
uci set nikki.mixin.tproxy_port='7892'
uci set nikki.mixin.authentication='0'
uci set nikki.mixin.tun_device='nikki'
uci set nikki.mixin.tun_stack='gvisor'
uci set nikki.mixin.tun_dns_hijack='0'
uci add_list nikki.mixin.tun_dns_hijacks='tcp://any:53'
uci add_list nikki.mixin.tun_dns_hijacks='udp://any:53'
uci set nikki.mixin.dns_listen='[::]:7874'
uci set nikki.mixin.dns_ipv6='1'
uci set nikki.mixin.dns_mode='fake-ip'
uci set nikki.mixin.fake_ip_range='198.18.0.1/16'
uci set nikki.mixin.fake_ip_filter='1'
uci set nikki.mixin.fake_ip_cache='1'
uci set nikki.mixin.hosts='1'
uci set nikki.mixin.dns_nameserver='1'
uci set nikki.mixin.dns_nameserver_policy='0'
uci set nikki.mixin.sniffer_force_domain_name='0'
uci set nikki.mixin.sniffer_ignore_domain_name='0'
uci set nikki.mixin.sniffer_sniff='1'
uci set nikki.mixin.rule='0'
uci set nikki.mixin.rule_provider='0'
uci set nikki.mixin.mixin_file_content='0'
uci set nikki.mixin.unify_delay='1'
uci set nikki.mixin.tcp_concurrent='1'
uci set nikki.mixin.tcp_keep_alive_idle='600'
uci set nikki.mixin.tcp_keep_alive_interval='15'
uci set nikki.mixin.ui_name='Zashboard'
uci set nikki.mixin.api_secret='123456'  # 请修改
uci set nikki.mixin.tun_mtu='9000'
uci set nikki.mixin.tun_gso='1'
uci set nikki.mixin.tun_gso_max_size='65536'
uci set nikki.mixin.tun_endpoint_independent_nat='0'
uci add_list nikki.mixin.fake_ip_filters='+.lan'
uci add_list nikki.mixin.fake_ip_filters='+.local'
uci add_list nikki.mixin.fake_ip_filters='geosite:cn'
uci add_list nikki.mixin.fake_ip_filters='+.quickcht3.club'
uci add_list nikki.mixin.fake_ip_filters='+.sevenka.top'
uci add_list nikki.mixin.fake_ip_filters='+.oneyyds.online'
uci add_list nikki.mixin.fake_ip_filters='+.sssyun.xyz'
uci add_list nikki.mixin.fake_ip_filters='+.xiaoniuyun.cc'
uci add_list nikki.mixin.fake_ip_filters='+.huawei-cloud.shop'
uci add_list nikki.mixin.fake_ip_filters='+.472361.xyz'
uci set nikki.mixin.fake_ip_filter_mode='blacklist'
uci set nikki.mixin.dns_respect_rules='0'
uci set nikki.mixin.dns_doh_prefer_http3='0'
uci set nikki.mixin.dns_system_hosts='1'
uci set nikki.mixin.dns_hosts='0'
uci set nikki.mixin.sniffer='1'
uci set nikki.mixin.sniffer_sniff_dns_mapping='1'
uci set nikki.mixin.sniffer_sniff_pure_ip='1'
uci set nikki.mixin.geoip_format='dat'
uci set nikki.mixin.geodata_loader='standard'
uci set nikki.mixin.geosite_url='https://testingcf.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geosite.dat'
uci set nikki.mixin.geoip_dat_url='https://testingcf.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geoip.dat'
uci set nikki.mixin.geox_auto_update='1'
uci set nikki.mixin.geox_update_interval='24'

# 环境配置
uci set nikki.env=env
uci set nikki.env.disable_safe_path_check='0'
uci set nikki.env.disable_loopback_detector='0'
uci set nikki.env.disable_quic_go_gso='0'
uci set nikki.env.disable_quic_go_ecn='0'
uci set nikki.env.disable_ipv6_check '0'

# 路由访问控制（第一组）
uci set nikki.@router_access_control[1]=router_access_control
uci set nikki.@router_access_control[1].enabled='1'
uci set nikki.@router_access_control[1].dns='0'
uci set nikki.@router_access_control[1].proxy='1'


# LAN访问控制
uci set nikki.lan_access_control=lan_access_control
uci set nikki.lan_access_control.enabled='1'
uci set nikki.@router_access_control[1].dns='0'
uci set nikki.lan_access_control.proxy='1'

# 认证配置
uci set nikki.authentication=authentication
uci set nikki.authentication.enabled='1'
uci set nikki.authentication.username='nikki'  # 建议修改
uci set nikki.authentication.password='nikki'  # 必须修改

# 域名配置
uci set nikki.hosts=hosts
uci set nikki.hosts.enabled='1'
uci set nikki.hosts.domain_name='*.grandway.top'  # 替换为实际域名
uci set nikki.hosts.ip='192.168.1.10'

# DNS服务器配置
uci set nikki.@nameserver[0]=nameserver
uci set nikki.@nameserver[0].enabled='0'
uci set nikki.@nameserver[0].type='default-nameserver'
uci add_list nikki.@nameserver[0].nameserver='223.5.5.5'
uci add_list nikki.@nameserver[0].nameserver='119.29.29.29'

uci set nikki.@nameserver[0]=nameserver
uci set nikki.@nameserver[0].enabled='0'
uci set nikki.@nameserver[0].type='proxy-server-nameserver'
uci add_list nikki.@nameserver[0].nameserver='223.5.5.5'
uci add_list nikki.@nameserver[0].nameserver='119.29.29.29'

uci set nikki.@nameserver[0]=nameserver
uci set nikki.@nameserver[0].enabled='0'
uci set nikki.@nameserver[0].type='direct-nameserver'
uci add_list nikki.@nameserver[0].nameserver='https://dns.alidns.com/dns-query'
uci add_list nikki.@nameserver[0].nameserver='https://doh.pub/dns-query'

uci set nikki.@nameserver[0]=nameserver
uci set nikki.@nameserver[0].enabled='0'
uci set nikki.@nameserver[0].type='nameserver'
uci add_list nikki.@nameserver[0].nameserver='202.96.128.86'
uci add_list nikki.@nameserver[0].nameserver='202.96.134.133'

uci set nikki.@nameserver[0]=nameserver
uci set nikki.@nameserver[0].enabled='0'
uci set nikki.@nameserver[0].type='fallback'
uci add_list nikki.@nameserver[0].nameserver='https://dns.cloudflare.com/dns-query'
uci add_list nikki.@nameserver[0].nameserver='https://dns.google/dns-query'

uci set nikki.@nameserver[0]=nameserver
uci set nikki.@nameserver[0].enabled='1'
uci set nikki.@nameserver[0].type='nameserver'
uci add_list nikki.@nameserver[0].nameserver='192.168.1.10:54'

# 提交所有更改
uci commit nikki

# 重启服务
/etc/init.d/nikki restart

exit 0
